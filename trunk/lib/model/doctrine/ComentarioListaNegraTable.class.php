<?php

/**
 * ComentarioListaNegraTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ComentarioListaNegraTable extends Doctrine_Table {

  /**
   * Returns an instance of this class.
   *
   * @return object ComentarioListaNegraTable
   */
  public static function getInstance() {
    return Doctrine_Core::getTable('ComentarioListaNegra');
  }

  public static function userHasComment($user, $objecto) {
    $interval = DateInterval::createFromDateString(sfConfig::get('app_auditorias_intervaloRepeticion', '0 Day'));
    $date = new DateTime();
    $className = get_class($objecto);
    $q = self::getInstance()->createQuery('q')
            ->where('q.sf_guard_user_id = ?', $user->getId())
            ->andWhere('q.' . $className . '_id = ?', $objecto->getId())
            ->andWhere('q.created_at > ?', $date->sub($interval)->format('Y-m-d H:i:s'))
            ->count();

    return $q ? true : false;
  }

  public function getAprobadoQuery($aprobado, $order = 'DESC') {
    $q = $this->getInstance()->createQuery('q')
            ->where('q.aprobado = ?', $aprobado)
            ->orderBy('q.id ' . $order);

    return $q;
  }

  /**
   * fetch Comment records for user id
   * @param String $user_id User Id
   * @return Reocrds
   */
  public function getUserCommentRecords($user_id) {
    //create comment query
    $comment_query = Doctrine_Query::create()
            ->select('cln.id,e.name company_name,p.name product_name,p.marca,p.modelo,e.slug company_slug, p.slug product_slug, cln.created_at created_date')
            ->from('ComentarioListaNegra cln')
            ->leftJoin('cln.Empresa e')
            ->leftJoin('cln.Producto p')
            ->where('cln.sf_guard_user_id =?', $user_id)
            ->andWhere('cln.aprobado = 1')
            ->orderby('cln.created_at DESC');
    //retrun comment query
    return $comment_query->fetchArray();
  }

}