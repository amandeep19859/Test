<?php

/**
 * EmpresaProductoEvolucionTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class EmpresaProductoEvolucionTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object EmpresaProductoEvolucionTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('EmpresaProductoEvolucion');
    }

    /**
     * @static
     * @param $anual
     */
    public static function getEvolucionEmpresaAnual($empresa_id)
    {
        $interval = new DateInterval('P1Y');
        $date = new DateTime();
        $date_from = $date->sub($interval);

        /** @var $q Doctrine_Query */
        $q = self::getInstance()->createQuery('q')
            ->select('q.puntuacion, q.date')
            ->addWhere('q.date > ?', $date_from->format('y-m-d'))
            ->addWhere('q.empresa_id = ?', $empresa_id)
            ->orderBy('q.date')
            ->limit(12);

        return $q->execute(array(), Doctrine_Core::HYDRATE_SCALAR);
    }

    /**
     * @static
     * @param $anual
     */
    public static function getEvolucionProductoAnual($producto_id)
    {
        $interval = new DateInterval('P1Y');
        $date = new DateTime();
        $date_from = $date->sub($interval);

        /** @var $q Doctrine_Query */
        $q = self::getInstance()->createQuery('q')
            ->select('q.puntuacion, q.date')
            ->addWhere('q.date >= ?', $date_from->format('y-m-d'))
            ->addWhere('q.producto_id = ?', $producto_id)
            ->orderBy('q.date')
            ->limit(12);

        return $q->execute(array(), Doctrine_Core::HYDRATE_SCALAR);
    }

    public static function getEvolucionProductoAnualNormalizado($producto_id)
    {
        $evolucion = self::getEvolucionProductoAnual($producto_id);
        $valores = array_map(function ($value) {
            $punt = $value['q_puntuacion'];
            if ($punt > 51 && $punt <= 60) {
                $value['q_puntuacion'] = 4;
                $value['medalla'] = 'Oro';
                return $value;
            } elseif ($punt > 40) {
                $value['q_puntuacion'] = 3;
                $value['medalla'] = 'Plata';

                return $value;

            } elseif ($punt > 32) {
                $value['q_puntuacion'] = 2;
                $value['medalla'] = 'Bronze';

                return $value;

            } else {
                $value['q_puntuacion'] = 1;
                $value['medalla'] = 'Ninguna';

                return $value;

            }

        }, $evolucion);
        return $valores;

    }

    public static function getEvolucionEmpresaAnualNormalizado($empresa_id)
    {
        $evolucion = self::getEvolucionEmpresaAnual($empresa_id);
        $valores = array_map(function ($value) {
            $punt = $value['q_puntuacion'];
            if ($punt > 51) {
                $value['q_puntuacion'] = 4;
                $value['medalla'] = 'Oro';
                return $value;
            } elseif ($punt > 40) {
                $value['q_puntuacion'] = 3;
                $value['medalla'] = 'Plata';

                return $value;

            } elseif ($punt > 32) {
                $value['q_puntuacion'] = 2;
                $value['medalla'] = 'Bronze';

                return $value;

            } else {
                $value['q_puntuacion'] = 1;
                $value['medalla'] = 'Ninguna';

                return $value;

            }

        }, $evolucion);
        return $valores;

    }
}